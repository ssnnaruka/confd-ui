//>>built
define("gridx/modules/View",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../core/_Module"],function(s,l,p,q,t){return s(t,{name:"view",load:function(a){var b=this,c=b.model;a=b.grid;var f=a.persist?a.persist.registerAndLoad("tree",function(){return b._openInfo}):{};b._clear();b.aspect(c,"onSizeChange","_onSizeChange");b.aspect(c,"onDelete","_onDelete");b.aspect(c,"setStore",function(){b.arg("clearOnSetStore")&&b._clear()},b,"before");b._loadLevels(f).then(function(){var a=
b._openInfo[""].count=c.size();b.rootCount=b.rootCount||a-b.rootStart;b.rootStart+b.rootCount>a&&(b.rootCount=a-b.rootStart);for(var e in f)b._expand(e);b._updateVC();b.loaded.callback()},function(a){b._err=a;b.loaded.callback()})},rowMixin:{visualIndex:function(){return this.grid.view.getRowInfo({rowId:this.id}).visualIndex}},clearOnSetStore:!0,rootStart:0,rootCount:0,visualCount:0,getRowInfo:function(a){var b=this.model,c=a.rowId;b.isId(c)&&(a.rowIndex=b.idToIndex(c),a.parentId=b.parentId(c));if("number"==
typeof a.rowIndex&&0<=a.rowIndex)b.isId(a.parentId)||(a.parentId=""),a.visualIndex=this._getVisualIndex(a.parentId,a.rowIndex);else if("number"==typeof a.visualIndex&&0<=a.visualIndex){var f=b.layerId();if(b.isId(f))a.rowIndex=a.visualIndex,a.parentId=f;else{for(var d=this._openInfo[""].openned,f=this.rootStart+a.visualIndex,e=0;e<d.length;++e){var g=this._openInfo[d[e]];if(b.idToIndex(g.id)<this.rootStart)f+=g.count;else break}for(d={parentId:"",preCount:0};!d.found;)d=this._getChild(f,d);a.rowIndex=
d.rowIndex;a.parentId=d.parentId}}else return a;a.rowId=b.isId(c)?c:b.indexToId(a.rowIndex,a.parentId);return a},logicExpand:function(a){var b=this,c=new q;b.model.when({parentId:a,start:0,count:1},function(){b._expand(a)&&b._updateVC()}).then(function(){c.callback()},function(a){c.errback(a)});return c},logicCollapse:function(a){var b=this._openInfo,c=b[a];if(c){var f=this.model.parentId(a),d=this._parentOpenInfo[f],e=c.count;d.splice(l.indexOf(d,a),1);for(c=b[f];c;)c.count-=e,c=b[c.parentId];delete b[a];
this.model.free(a,1);this._updateVC()}},updateRootRange:function(a,b,c){var f=this;f.rootStart=a;f.rootCount=b;return f.updateVisualCount().then(function(){if(!c)f.onUpdate()})},updateVisualCount:function(){var a=this;return a._loadLevels().then(function(){a._updateVC()})},onUpdate:function(){},_parentOpenInfo:null,_openInfo:null,_clear:function(){var a=[];this._openInfo={"":{id:"",parentId:null,path:[],count:0,openned:a}};this._parentOpenInfo={"":a}},_expand:function(a){var b=this.model;if(b.hasChildren(a)){var c=
b.parentId(a),f=this._openInfo,d=this._parentOpenInfo,e=d[c]=d[c]||[];d[a]=d[a]||[];if(!f[a]&&0<=b.idToIndex(a)){b.keep(a,1);0>l.indexOf(e,a)&&e.push(a);for(var e=b.size(a),g=d[a].length-1;0<=g;--g)e+=f[d[a][g]].count;f[a]={id:a,parentId:c,path:b.treePath(a).slice(1).concat([a]),count:e,openned:d[a]};for(a=f[c];a;)a.count+=e,a=f[a.parentId];return 1}}},_getVisualIndex:function(a,b){var c=this.model,f=this._openInfo,d=f[a],e=0,g=""===a?b:c.idToIndex(c.rootId(a));if(d&&g>=this.rootStart&&g<this.rootStart+
this.rootCount){for(;d;){e+=b;for(g=0;g<d.openned.length;++g){var h=f[d.openned[g]],k=c.idToIndex(h.id);if(k<b&&(""!==d.id||k>=this.rootStart))e+=h.count}d.openned.sort(function(a,b){return c.idToIndex(a)-c.idToIndex(b)});b=c.idToIndex(d.id);c.isId(d.id)&&e++;d=f[d.parentId]}return e-this.rootStart}return null},_getChild:function(a,b){var c=this.model,f=this._openInfo[b.parentId],d=b.preCount+c.idToIndex(f.id)+1,e={found:!0,visualIndex:a};f.openned.sort(function(a,b){return c.idToIndex(a)-c.idToIndex(b)});
for(var g=0,h=f.openned.length;g<h;++g){var k=f.openned[g],n=this._openInfo[k],r=c.idToIndex(k),m=r+d;if(m===a)return p.mixin({parentId:f.id,rowIndex:r},e);if(m<a&&m+n.count>=a)return{parentId:k,preCount:d};m+n.count<a&&(d+=n.count)}return p.mixin({parentId:f.id,rowIndex:a-d},e)},_loadLevels:function(a){a=a||this._openInfo;var b=this.model,c=new q,f,d=[];for(f in a)if(b.isId(f)){var e,g=a[f].path;for(e=0;e<g.length;++e)d[e]=d[e]||[],d[e].push({parentId:g[e],start:0,count:1})}var h=function(a){a<d.length?
b.when(d[a],function(){l.forEach(d[a],function(a){b.keep(a.parentId,1)});h(a+1)}).then(null,function(a){c.errback(a)}):b.when({}).then(function(){c.callback()},function(a){c.errback(a)})};h(0);return c},_updateVC:function(){var a=this.model,b=this._openInfo,c=b[""],f=c.openned.length,d=a.size(),e,g,h;d<this.rootStart+this.rootCount&&(d>this.rootStart?this.rootCount=d-this.rootStart:(this.rootStart=0,this.rootCount=d));d=this.rootCount;for(e=0;e<f;++e)g=b[c.openned[e]],h=a.idToIndex(g.id),h>=this.rootStart&&
h<this.rootStart+this.rootCount&&(d+=g.count);this.visualCount=d},_onSizeChange:function(a,b){!this.paging&&(0===this.rootStart&&(this.rootCount===b||0>b))&&this.updateRootRange(0,a)},_onDelete:function(a,b,c){if(c){var f=this._openInfo,d=this._parentOpenInfo,e=f[a],g=this.model,h=c.pop();c=1;var k=function(a,b){var c=f[a];l.forEach(d[a]||[],function(a){k(a)});delete d[a];if(c)delete f[a],b=c.parentId;else if(!g.isId(b))return;var c=d[b],e=l.indexOf(c,a);0<=e&&c.splice(e,1)};e?(c+=e.count,e=f[e.parentId]):
g.isId(h)&&(e=f[h]);for(k(a,h);e;)e.count-=c,e=f[e.parentId];String(h)==String(g.layerId())&&(b>=this.rootStart&&b<this.rootStart+this.rootCount)&&this.rootCount--;a=g.idToIndex(g.rootId(a));a>=this.rootStart&&a<this.rootStart+this.rootCount&&(this.visualCount-=c)}else this._clear();this.grid.body.lazyRefresh()}})});
//# sourceMappingURL=View.js.map