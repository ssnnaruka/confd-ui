//>>built
define("gridx/modules/VirtualVScroller","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/sniff dojo/_base/event dojo/_base/Deferred ../support/query dojo/keys ./VScroller ../core/_Module".split(" "),function(E,z,y,A,B,F,C,u,D,G){return E(D,{constructor:function(b,a){b.autoHeight?z.mixin(this,new D(b,a)):this._scrolls=[]},destroy:function(){this.inherited(arguments);clearTimeout(this._lazyScrollHandle);clearTimeout(this._pVirtual)},buffSize:5,lazy:!1,lazyTimeout:50,scrollToRow:function(b,
a){var f=new F,d=this,c=d._scrolls,e=function(){d._subScrollToRow(b,f,a)};c.push(f);d._lazy=d.arg("lazy");d.lazy=!1;1<c.length?c[c.length-2].then(e):e();return f},_subScrollToRow:function(b,a,f){var d=this,c=0,e=d._avgRowHeight,g=d.grid.bodyNode,k=d.domNode,c=g.scrollTop,s=k.scrollTop,l=g.clientHeight,m=C('[visualindex\x3d"'+b+'"]',g)[0],v=d.grid.focus,p=function(c){c&&!m.getAttribute("rowid")?a.scrollContext=[b,a,f]:(d._scrolls.splice(y.indexOf(d._scrolls,a),1),v&&"body"==v.currentArea()&&v.focusArea("body",
1),d.lazy=d._lazy,a.callback(c))};if(m)if(e=m.offsetTop,m.offsetHeight>=l){if(e==c){p(!0);return}c=e-c}else if(e+m.offsetHeight>c+l)c=e-c,f||(c+=m.offsetHeight-l);else if(e<c||f&&e>c)c=e-c;else{p(!0);return}else if(g.childNodes.length){for(var h=g.firstChild;h&&h.offsetTop<c;)h=h.nextSibling;var t=h&&h.getAttribute("visualindex");if(h&&b<t)c=(b-t)*e;else{for(h=g.lastChild;h&&h.offsetTop+h.offsetHeight>c+l&&h!=g.firstChild;)h=h.previousSibling;t=h&&h.getAttribute("visualindex");if(h&&b>t)c=(b-t)*e;
else{p(!1);return}}}else{p(!1);return}l=0===s&&0>c;s=s>=k.scrollHeight-k.offsetHeight&&0<c;if(l||s)d._doVirtualScroll(1);else if(e=k.scrollTop,c=e+(c>g.offsetHeight?c/d._ratio:c),c>k.scrollHeight&&(c=k.scrollHeight),k.scrollTop=c,k.scrollTop==e){p(!1);return}l&&0==g.firstChild.getAttribute("visualindex")||s&&g.lastChild.getAttribute("visualindex")==d.grid.view.visualCount-1?p(!1):setTimeout(function(){d._subScrollToRow(b,a,f)},5)},_init:function(b){var a=this;a._avgRowHeight=a.grid.body.arg("defaultRowHeight")||
24;a._rowHeight={};a._syncHeight();a.connect(a.grid,"_onResizeEnd",function(){a._doScroll(0,1)});a._doScroll(0,1,1)},_doVirtualScroll:function(b){var a=this.domNode,f=a.scrollTop,d=f-(this._lastScrollTop||0);if(b||d){this._lastScrollTop=f;var c=this.arg("buffSize");b=a.scrollHeight-a.offsetHeight;var e=this.grid.body,g=0+this.grid.view.visualCount,k=this.grid.bodyNode,s=k.firstChild,l=s&&s.clientTop-d,m=k.lastChild,v=m&&m.offsetTop-d+m.offsetHeight,p=k.scrollTop,h=p+k.clientHeight,t=this._avgRowHeight,
u=Math.ceil(a.offsetHeight/t)+2*c,w=this._ratio,a=2>=f,x=2>=Math.abs(f-b),n,q,r;if(p==h&&!h||m&&0>m.offsetTop)return;s&&l>p&&l<h?(q=e.renderStart,r=Math.ceil((l-p)*w/t)+c,n=a?0:Math.max(q-r,0),r="top"):m&&v>p&&v<h?(n=e.renderStart+e.renderCount,r=Math.ceil((h-v)*w/t)+c,q=x&&f?g:Math.min(n+r,g),r="bottom",0===d&&n==g&&(q=e.renderStart,r=Math.ceil((l-p)*w/t)+c,n=a?0:Math.max(q-r,0),r="top")):!s||l>h||!m||v<p?(f<=b/2?(n=a?0:0+Math.max(Math.floor(f*w/t)-c,0),q=Math.min(n+u,g)):(q=x?g:g+Math.min(u-Math.floor((b-
f)*w/t),0),n=Math.max(q-u,0)),r="clear"):s&&(a?(g=e.renderStart,0<g&&(n=0,q=g,r="top")):x&&(c=e.renderStart+e.renderCount-1,c<g-1&&(n=c+1,q=g,r="bottom")));"number"==typeof n&&"number"==typeof q&&(e.renderRows(n,q-n,r),f&&n<q&&(n=C('[visualindex\x3d"'+q+'"]',k)[0])&&(d+=n.offsetTop));a?k.scrollTop=0:x||f>b?k.scrollTop=k.scrollHeight:"clear"!=r&&(k.scrollTop+=d)}this._doVirtual()},_doScroll:function(b,a,f){if(!this._lock||a)!f&&this.arg("lazy")&&!a?(this._lazyScrollHandle&&clearTimeout(this._lazyScrollHandle),
this._lazyScrollHandle=setTimeout(z.hitch(this,this._doVirtualScroll,a),this.arg("lazyTimeout"))):this._doVirtualScroll(a)},_onMouseWheel:function(b){"none"!=this.grid.vScrollerNode.style.display&&(this.domNode.scrollTop-="number"===typeof b.wheelDelta?b.wheelDelta/3:-40*b.detail,B.stop(b))},_onBodyChange:function(){var b=this;b._update();b._doScroll(0,1);y.forEach(b._scrolls,function(a){if(a&&a.scrollContext){var f=a.scrollContext;delete a.scrollContext;b._subScrollToRow.apply(b,f)}})},_onForcedScroll:function(){this._rowHeight=
{};this._doScroll(0,1)},_avgRowHeight:24,_rowHeight:null,_ratio:1,_syncHeight:function(){var b=this._avgRowHeight*this.grid.view.visualCount,a=1342177;A("ff")?a=17895697:A("webkit")&&(a=134217726);b>a&&(this._ratio=b/a,b=a);var a=this.domNode,f=this.grid.bodyNode,d=a.scrollTop,c=d>=a.scrollHeight-a.offsetHeight;this.stubNode.style.height=b+"px";this._lastScrollTop&&(a.scrollTop=c?a.scrollHeight:d,this._lastScrollTop=a.scrollTop);a.scrollTop>=a.scrollHeight-a.offsetHeight?f.scrollTop=f.scrollHeight:
a.scrollTop||(f.scrollTop=0)},_doVirtual:function(){var b=this;clearTimeout(b._pVirtual);b._pVirtual=setTimeout(function(){b._updateRowHeight()},100)},_updateRowHeight:function(b){var a=0,f=0,d=this.grid,c=d.body,d=d.bodyNode,e=this.buffSize*this._avgRowHeight,g=d.scrollTop,k=g-e,s=g+d.clientHeight+e,l=this._rowHeight,e=0;y.forEach(d.childNodes,function(b){var c=b.offsetHeight;l[b.getAttribute("rowid")]=c;b.setAttribute("data-rowHeight",c);b.offsetTop>s?++f:b.offsetTop+b.offsetHeight<k&&++a});"post"!=
b&&(c.unrenderRows(a),e=a);"pre"!=b&&(c.unrenderRows(f,"post"),e=f);var m,c=b=0;for(m in l)b+=l[m],++c;b&&c&&(this._avgRowHeight=b/c,this._syncHeight());return e},_onKeyScroll:function(b){var a=this.grid.body,f=this.grid.view,d=this.grid.focus,c=this.domNode,e=this.grid._isCtrlKey(b);if(!d||"body"==d.currentArea()){if(b.keyCode==u.HOME&&e)a._focusCellCol=0,a._focusCellRow=0,c.scrollTop=0,a._focusCell();else if(b.keyCode==u.END&&e)a._focusCellCol=this.grid._columns.length-1,a._focusCellRow=f.visualCount-
1,c.scrollTop=this.stubNode.clientHeight-a.domNode.offsetHeight,a._focusCell();else if(b.keyCode==u.PAGE_UP)a=a._focusCellRow=Math.max(a.renderStart-a.renderCount,0),this.scrollToRow(a);else if(b.keyCode==u.PAGE_DOWN)a=a._focusCellRow=Math.min(f.visualCount-1,a.renderStart+a.renderCount),this.scrollToRow(a,1);else return;B.stop(b)}}})});
//# sourceMappingURL=VirtualVScroller.js.map