//>>built
define("gridx/modules/dnd/_Dnd","dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/dom-construct dojo/dom-geometry dojo/dom-class dojo/dom-style dojo/dom dojo/_base/window dojo/_base/sniff dojo/dnd/Source dojo/dnd/Manager ../../core/_Module ../AutoScroll".split(" "),function(r,h,s,k,n,f,t,p,e,u,l,m,q){var g=h.hitch;return q.register(r(q,{name:"_dnd",optional:["selectRow","selectColumn"],constructor:function(){var b=this,a=b.grid,c=e.doc;b.accept=[];b._profiles={};b._selectStatus={};b._node=
k.create("div");b.batchConnect([a,"onCellMouseOver","_checkDndReady"],[a,"onCellMouseOut","_dismissDndReady"],[a,"onCellMouseDown","_beginDnd"],[c,"onmouseup","_endDnd"],[c,"onmousemove","_onMouseMove"],[a,"onCellMouseUp",function(a){setTimeout(function(){b._checkDndReady(a)},0)}]);b.subscribe("/dnd/cancel","_endDnd")},load:function(b){b=this.arg("sourceNode",this.grid.mainNode);this._source=new l(b,{isSource:!1,accept:this.accept,getSelectedNodes:function(){return[0]},getItem:g(this,"_getItem"),
onSelectStart:function(){this.notSelectText&&l.prototype.onSelectStart.apply(this,arguments)},checkAcceptance:g(this,"_checkAcceptance"),onDraggingOver:g(this,"_onDraggingOver"),onDraggingOut:g(this,"_onDraggingOut"),onDropExternal:g(this,"_onDropExternal"),onDropInternal:g(this,"_onDropInternal")});u("ff")&&this._fixFF(this._source,b);this._source.grid=this.grid;this._saveSelectStatus();this.loaded.callback()},destroy:function(){this.inherited(arguments);this._source.destroy();k.destroy(this._node)},
getAPIPath:function(){return{dnd:{_dnd:this}}},profile:null,register:function(b,a){this._profiles[b]=a;[].push.apply(this.accept,a.arg("accept"))},_fixFF:function(b){return this.connect(e.doc,"onmousemove",function(a){var c=n.position(b.node),d=a.clientX,f=a.clientY;a=b._alreadyIn;c=f>=c.y&&f<=c.y+c.h&&d>=c.x&&d<=c.x+c.w;!a&&c?(b._alreadyIn=1,b.onOverEvent()):a&&!c&&(b._alreadyIn=0,b.onOutEvent())})},_onMouseMove:function(b){this._alreadyIn&&(this._dnding||this._extDnding)&&this._markTargetAnchor(b)},
_saveSelectStatus:function(b){var a,c,d=this.grid.select;if(d)for(a in d)if((c=d[a])&&h.isObject(c))this._selectStatus[a]=c.arg("enabled"),void 0!==b&&(c.enabled=b)},_loadSelectStatus:function(){var b,a,c=this.grid.select;if(c)for(b in c)if((a=c[b])&&h.isObject(a))a.enabled=this._selectStatus[b]},_checkDndReady:function(b){var a,c;if(!this._dndReady&&!this._dnding&&!this._extDnding)for(a in this._profiles)if(c=this._profiles[a],c.arg("enabled")&&c._checkDndReady(b)){this.profile=c;this._saveSelectStatus(!1);
f.add(e.body(),"gridxDnDReadyCursor");this._dndReady=this._source.notSelectText=1;break}},_dismissDndReady:function(){this._dndReady&&!this._dndBegun&&(this._loadSelectStatus(),this._dndReady=0,f.remove(e.body(),"gridxDnDReadyCursor"))},_beginDnd:function(b){var a=this;a._checkDndReady(b);if(a._dndReady){var c=a.profile,d=m.manager();a._dndBegun=1;a._source.isSource=!0;a._source.canNotDragOut=!c.arg("provide").length;a._node.innerHTML=c._buildDndNodes();a._oldStartDrag=d.startDrag;d.startDrag=g(a,
"_startDrag",b);a.avatar&&(a._oldMakeAvatar=d.makeAvatar,d.makeAvatar=function(){return new a.avatar(d)});d._dndInfo={grid:a.grid,cssName:c._cssName,count:c._getDndCount()};a.grid.vScrollerNode.focus();c._onBeginDnd(a._source);p.setSelectable(a.grid.domNode,!1)}},_endDnd:function(){var b=m.manager();this._source.isSource=!1;this._dndBegun=this._alreadyIn=0;delete b._dndInfo;this._oldStartDrag&&(b.startDrag=this._oldStartDrag,delete this._oldStartDrag);this._oldMakeAvatar&&(b.makeAvatar=this._oldMakeAvatar,
delete this._oldMakeAvatar);if(this._dndReady||this._dnding||this._extDnding)this._dnding=this._extDnding=0,this._destroyUI(),p.setSelectable(this.grid.domNode,!0),f.remove(e.body(),"gridxDnDReadyCursor"),this.profile._onEndDnd(),this._source.notSelectText=0,this._loadSelectStatus()},_createUI:function(){f.add(e.body(),"gridxDnDCursor");this.grid.autoScroll&&(this.profile._onBeginAutoScroll(),this.grid.autoScroll.enabled=!0)},_destroyUI:function(){this._unmarkTargetAnchor();f.remove(e.body(),"gridxDnDCursor");
this.grid.autoScroll&&(this.profile._onEndAutoScroll(),this.grid.autoScroll.enabled=!1)},_createTargetAnchor:function(){return k.create("div",{"class":"gridxDnDAnchor"})},_markTargetAnchor:function(b){if(this._extDnding||this.profile.arg("canRearrange")){var a=this._targetAnchor,c=n.position(this.grid.mainNode);a||(a=this._targetAnchor=this._createTargetAnchor(),a.style.display="none",this.grid.mainNode.appendChild(a));f.add(a,"gridxDnDAnchor"+this.profile._cssName);(b=this.profile._calcTargetAnchorPos(b,
c))?(t.set(a,b),a.style.display="block"):a.style.display="none"}},_unmarkTargetAnchor:function(){var b=this._targetAnchor;b&&(b.style.display="none",f.remove(b,"gridxDnDAnchor"+this.profile._cssName))},_startDrag:function(b,a,c,d){this._dndReady&&a===this._source&&(this._oldStartDrag.call(m.manager(),a,this._node.childNodes,d),this._dndReady=0,this._dnding=this._alreadyIn=1,this._createUI(),this._markTargetAnchor(b))},_getItem:function(b){return{type:this.profile.arg("provide"),data:this.profile._getItemData(b)}},
_checkAcceptance:function(b,a){var c=function(a){for(var b={},c=a.length-1;0<=c;--c)b[a[c]]=1;return b},d=l.prototype.checkAcceptance;if(d.apply(this._source,arguments)){if(b.grid===this.grid)return this.profile.arg("canRearrange");if(!b.canNotDragOut)for(var f in this._profiles){var e=this._profiles[f],g=d.apply({accept:c(e.arg("accept"))},arguments);if(e.arg("enabled")&&g&&(!e.checkAcceptance||e.checkAcceptance.apply(e,arguments)))return this.profile=e,this._extDnding=1,!0}}return!1},_onDraggingOver:function(){if(this._dnding||
this._extDnding)this._alreadyIn=1,this._createUI()},_onDraggingOut:function(){if(this._dnding||this._extDnding)this._alreadyIn=0,this._destroyUI()},_onDropInternal:function(b,a){this.profile._onDropInternal(b,a);this._endDnd()},_onDropExternal:function(b,a,c){var d=this;a=d.profile._onDropExternal(b,a,c);s.when(a,function(){if(!c)if(b.grid)b.grid.dnd._dnd.profile.onDraggedOut(d._source);else b.deleteSelectedNodes()})}}))});
//# sourceMappingURL=_Dnd.js.map