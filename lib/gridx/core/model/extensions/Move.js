//>>built
define("gridx/core/model/extensions/Move",["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/DeferredList","../_Extension"],function(u,z,q,A,v){function E(e,c){var b,f,h=[],g=[],a,d=1,m=1,k=c,l=c,n;b=0;for(f=e.length;b<f;++b)h[e[b]]=1;b=0;for(f=h.length;b<f;++b)h[b]?b<c?d?(d=0,a=[b,1],n=g.length,g.unshift(a)):h[b-1]&&++a[1]:m?(m=0,a=[b,1,l],g.push(a),++l):h[b-1]&&(++a[1],++l):d=m=1;for(b=0;b<=n;++b)a=g[b],a[2]=k,k-=a[1];return g}function F(e,c,b,f){var h={},g,a,d={};if(b>e+c){for(a=
0;a<c;++a)h[e+a]=b+a-c;for(a=0;a<b-e-c;++a)h[e+c+a]=e+a}else if(b<e){for(a=0;a<c;++a)h[e+a]=b+a;for(a=0;a<e-b;++a)h[b+a]=b+a+c}else return;for(g in f)d[f[g]]=parseInt(g,10);for(g in h)e=h[g],d.hasOwnProperty(g)&&(g=d[g]),g==e?delete f[g]:f[g]=e}var r=z.hitch;return u(v,{name:"move",priority:10,constructor:function(e,c){var b=e._cache.options=e._cache.options||{};this._mixinAPI("move","moveIndexes","insert");e.onMoved=function(){};c.updateStore&&(this.updateStore=c.updateStore);b.sort=c.moveSortInfo?
c.moveSortInfo:[{attribute:this.moveField=c.moveField||"order",descending:this.moveFieldDescending=c.moveFieldDescending||!1}]},move:function(e,c,b){0<=e&&(Infinity>e&&0<c&&Infinity>c&&0<=b&&Infinity>b&&(b<e||b>e+c))&&this.model._addCmd({name:"_cmdMove",scope:this,args:[e,c,b],async:1})},moveIndexes:function(e,c){this.model._addCmd({name:"_cmdMove",scope:this,args:[e,c],async:1})},insert:function(e,c,b){var f=new q,h=r(f,f.callback),g=r(f,f.errback),a=this.moveField,d=this.model.store,m,k=[];c=c?
d.fetch?d.getValue(c,a):c[a]:null;var l=b?d.fetch?d.getValue(b,a):b[a]:null;for(b=0;m=e[b];++b)if(c=null===c&&null===l?Math.random():null===c?l-1:null===l?c+1:(c+l)/2,m[a]=c,d.fetch)d.newItem(m);else{var n=new q;q.when(d.add(m),r(n,n.callback),r(n,n.errback));k.push(n)}d.fetch?d.save({onComplete:h,onError:g}):(new A(k)).then(h,g);return f},updateStore:function(e,c,b){var f=[],h=[],g=[];c=[];var a,d,m={},k,l={},n,B=0,w=this.inner,p=this.model.store,s=this.moveField,C=[],u=function(a){for(;a<f.length;++a){var b=
f[a];if(!h[b])return void 0===b?a:b}return a},t=function(a){return(a=w._call("byIndex",[a]))&&a.item},x=function(a){return p.fetch?p.getValue(a,s):a[s]},D=function(a,b){var c=h[a];return c?c.value:0>a?x(t(0))-1:a<b?x(t(a)):x(t(b-1))+1},v=function(){p.fetch?p.save({onComplete:function(){e.callback()},onError:function(a){e.errback(a)}}):(new A(C)).then(function(){e.callback()},function(a){e.errback(a)})},y=Infinity;for(a in b)a=parseInt(a,10),d=b[a],m[a]=d,d<y&&(y=d),f[d]=a;for(b=y;b<f.length;++b)void 0===
f[b]&&(f[b]=b,m[b]=b);for(a in m)a=parseInt(a,10),d=m[a],k=d-a,void 0===l[k]?l[k]=1:++l[k];for(k in l)l[k]>B&&(B=l[k],n=k);for(d=0;d<f.length;++d)a=f[d],void 0!==a&&d-a!=n&&(h[a]={},g.push(a));for(b=0;b<g.length;++b)a=g[b],d=m[a],k=h[a],n=0<d?void 0===f[d-1]?d-1:f[d-1]:-1,k=k.before=n,d=h[a].after=u(d),c.push({start:a,count:1},{start:d,count:1}),0<=k&&c.push({start:k,count:1});w._call("when",[{id:[],range:c},function(){for(var b=w._call("size"),c=0;c<g.length;++c){a=g[c];var e=t(a),d=h[a],f=D(d.before,
b),k=D(d.after,b),f=(f+k)/2,d=d.value=f;p.fetch?p.setValue(e,s,d):(e=z.clone(e),e[s]=d,d=new q,q.when(p.put(e,{overwrite:!0}),r(d,d.callback)),C.push(d))}v()}])},_cmdMove:function(){var e=new q,c=this.model,b,f,h={},g,a=[];this.inner._call("size");for(b=0;f=arguments[b];++b)c._msg("beforeMove",f),2==f.length?a=a.concat(E(f[0],f[1])):a.push(f);for(b=0;f=a[b];++b)F(f[0],f[1],f[2],h);for(b in h){g=1;break}g?this.updateStore(e,a,h):e.callback();e.then(function(){c._cache.clear();c._msg("moved",h);c.onMoved(a,
h)});return e}})});
//# sourceMappingURL=Move.js.map